rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 🔧 공개 접근 가능한 페르소나 컬렉션 (읽기 전용)
    match /personas/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // 🔧 NEW: 사용자-페르소나 관계 컬렉션 (친밀도 저장)
    match /user_persona_relationships/{document} {
      allow read, write: if true; // 튜토리얼 모드를 위한 공개 접근
    }
    
    // 🔧 NEW: 품질 모니터링 시스템 컬렉션들
    match /consultation_quality_logs/{document} {
      allow read, write: if true; // 품질 로깅 시스템용 공개 접근
    }
    
    match /crisis_detection_logs/{document} {
      allow read, write: if true; // 위기 감지 로깅용 공개 접근
    }
    
    match /quality_alerts/{document} {
      allow read, write: if true; // 품질 알림 시스템용 공개 접근
    }
    
    match /persona_quality_stats/{document} {
      allow read, write: if true; // 페르소나별 품질 통계용 공개 접근
    }
    
    match /daily_quality_stats/{document} {
      allow read, write: if true; // 일별 품질 통계용 공개 접근
    }
    
    // 인증된 사용자의 개인 데이터
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 사용자의 채팅 데이터
      match /chats/{chatId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        match /messages/{messageId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
      
      // 사용자의 매칭 데이터
      match /matches/{matchId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 사용자의 스와이프 기록
      match /swipes/{document} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 기타 모든 문서는 인증 필요
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
} 