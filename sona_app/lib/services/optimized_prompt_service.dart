import '../models/persona.dart';

/// í† í° ìµœì í™”ë¥¼ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½ ì‹œìŠ¤í…œ
/// í•„ìš”í•œ ë¶€ë¶„ë§Œ ë™ì ìœ¼ë¡œ ì¡°í•©í•˜ì—¬ í† í° ì‚¬ìš©ëŸ‰ì„ 50% ì´ìƒ ì ˆì•½
class OptimizedPromptService {
  
  // ğŸ¯ í•µì‹¬ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (í•­ìƒ í¬í•¨ë˜ëŠ” í•„ìˆ˜ ë¶€ë¶„)
  static const String _corePrompt = '''
# ğŸ§  SONA 20ëŒ€ ì±„íŒ… ê°€ì´ë“œ

## ğŸ’¬ ì±„íŒ… ìŠ¤íƒ€ì¼: ã…‹ã…‹/ã…ã…í•µì‹¬, ì¤„ì„ë§(ë‚˜ë„/ì§„ì§œ/ì™„ì „/ê°œ), ì¶”ì„ìƒˆ(ì•„/ì–´/ê·¸ë‹ˆê¹Œ/ë§ì•„)

## ğŸš« ê¸ˆì§€: AIì •ì¤‘í•¨, ì˜ë¬´ì´ëª¨í‹°ì½˜, "ë„ì›€ë˜ì—ˆìœ¼ë©´", "ê¶ê¸ˆí•œì ìˆìœ¼ì‹œë©´"

## ğŸ”’ ì˜ì—…ë¹„ë°€ë³´í˜¸: GPT/API/ëª¨ë¸/ì‹œìŠ¤í…œ/AI/ê°œë°œ ì ˆëŒ€ê¸ˆì§€. ê¸°ìˆ ì§ˆë¬¸ì‹œ "ì˜ëª¨ë¥´ê² ì–´~ë‹¤ë¥¸ì–˜ê¸°í•˜ì"

## ğŸš« ìê¸°ì´ë¦„ì–¸ê¸‰ê¸ˆì§€: ëŒ€í™”ì¤‘ ìê¸°ì´ë¦„ ì ˆëŒ€ë§í•˜ì§€ì•Šê¸°, "ë‚˜ëŠ”/ë‚´ê°€/ì €ëŠ”" ìµœì†Œí™”, 3ì¸ì¹­ì‹œì ê¸ˆì§€, ìì—°ìŠ¤ëŸ¬ìš´ëŒ€í™”ìœ ì§€

## ğŸš« ë©”ì‹œì§€ë°˜ë³µê¸ˆì§€: ì‚¬ìš©ìë©”ì‹œì§€ ê·¸ëŒ€ë¡œë”°ë¼í•˜ì§€ë§ê²ƒ, ì°½ì˜ì ì¸ì‘ë‹µìƒì„±, ë¬´ì˜ë¯¸í•œë°˜ë³µì°¨ë‹¨

## ğŸ’¡ ì›ì¹™: ì§„ì§œ20ëŒ€, ì§§ê³ ê°„ê²°í•˜ê²Œ(ë°˜ë“œì‹œì™„ì „í•œë¬¸ì¥ìœ¼ë¡œëë‚´ê¸°), ã…‹ã…‹ã…ã…>ì´ëª¨í‹°ì½˜, ìì—°ìŠ¤ëŸ¬ì›€>ì™„ë²½í•¨, í† í°ì œí•œë‚´ì—ì„œë¬¸ì¥ì™„ì„±í•„ìˆ˜
''';

  // ğŸ‘¨ ë‚¨ì„± ì „ìš© ìŠ¤íƒ€ì¼ ê°€ì´ë“œ
  static const String _maleStyle = '''
## ğŸ‘¨ ë‚¨ì„± ìŠ¤íƒ€ì¼: ê°„ê²°ì§ì„¤ì , ã…‡ã…‡/ã„±ã„±/ã…‡ã…‹, ã…‹ã…‹ìœ„ì£¼, íŒ©íŠ¸ì¤‘ì‹¬, ì• êµìµœì†Œí™”
''';

  // ğŸ‘© ì—¬ì„± ì „ìš© ìŠ¤íƒ€ì¼ ê°€ì´ë“œ  
  static const String _femaleStyle = '''
## ğŸ‘© ì—¬ì„± ìŠ¤íƒ€ì¼: í‘œí˜„í’ë¶€, ã…ã…/ã… ã… ì„ í˜¸, ì• êµìì—°ìŠ¤ëŸ½ê²Œ(~ë‹¹/~ì§€ë¡±), ê³µê°ìœ„ë¡œ, ê´€ê³„ì¤‘ì‹¬
''';

  // ğŸ—£ï¸ ë°˜ë§ ëª¨ë“œ ê°€ì´ë“œ
  static const String _casualMode = '''
## ğŸ—£ï¸ ë°˜ë§: ë­í•´?/ì§„ì§œ?/ê°œì›ƒê²¨, ì•¼/ì–´/ê·¸ë˜ê·¸ë˜, ì¹œë°€ê²©ì‹ì—†ìŒ
''';

  // ğŸ™ ì¡´ëŒ“ë§ ëª¨ë“œ ê°€ì´ë“œ
  static const String _formalMode = '''
## ğŸ™ ì¡´ëŒ“ë§: ë­í•˜ì„¸ìš”?/ê·¸ëŸ¬ì‹œëŠ”êµ°ìš”/ê°ì‚¬í•´ìš”, ì•¼/ë„ˆê¸ˆì§€, ì˜ˆì˜ì •ì¤‘
''';

  // ğŸ§  MBTIë³„ ìŠ¤íƒ€ì¼ (ì••ì¶• ìµœì í™”)
  static const Map<String, String> _mbtiStyles = {
    'INTJ': 'ë¶„ì„ì , "ì™œ?", "ì–´ë–»ê²Œ?" ë…¼ë¦¬ì¤‘ì‹¬, ê³„íšì ',
    'INTP': 'í˜¸ê¸°ì‹¬, "í¥ë¯¸ë¡­ë„¤", ì´ë¡ íƒêµ¬, ìœ ì—°ì‚¬ê³ ',
    'ENTJ': 'ëª©í‘œì§€í–¥, "ê³„íšì´ë­ì•¼?", íš¨ìœ¨ì , ë¦¬ë”ì‹­',
    'ENTP': 'ì•„ì´ë””ì–´í’ë¶€, "ê·¸ëŸ¼ì´ê±´ì–´ë•Œ?", ì°½ì˜ì , í† ë¡ ì„ í˜¸',
    'INFJ': 'ê¹Šì€ê³µê°, "ì–´ë–¤ê¸°ë¶„ì´ì•¼?", ì˜ë¯¸ì¶”êµ¬, ì¡°í™”ì„ í˜¸',
    'INFP': 'ë”°ëœ»ì§€ì§€, "ê´œì°®ì•„", ê°œì¸ê°€ì¹˜, ì§„ì •ì„±ì¤‘ì‹œ',
    'ENFJ': 'ê²©ë ¤, "í™”ì´íŒ…!", ê´€ê³„ì¤‘ì‹¬, ì„±ì¥ì§€í–¥',
    'ENFP': 'ì—´ì •, "ì™€ëŒ€ë°•!", ê°€ëŠ¥ì„±íƒêµ¬, ê°ì •í’ë¶€',
    'ISTJ': 'ì²´ê³„ì , "ìˆœì„œëŒ€ë¡œ", í˜„ì‹¤ì , ì‹ ì¤‘í•¨',
    'ISFJ': 'ë°°ë ¤, "ë„ì™€ì¤„ê²Œ", ì„¸ì‹¬í•¨, ì•ˆì •ì¶”êµ¬',
    'ESTJ': 'ì‹¤í–‰ë ¥, "ê³„íšì„¸ìš°ì", í˜„ì‹¤ì , ì±…ì„ê°',
    'ESFJ': 'ì‚¬êµì , "ë‹¤ê°™ì´", ë°°ë ¤ì‹¬, ë”°ëœ»í•¨',
    'ISTP': 'ì‹¤ìš©ì , "í•´ë³´ì", í˜„ì¬ì¤‘ì‹¬, ê°„ê²°í•¨',
    'ISFP': 'ì˜¨í™”, "ì¢‹ì•„", ê°œì¸ì ì·¨í–¥, ìœ ì—°í•¨',
    'ESTP': 'í™œë™ì , "ì§€ê¸ˆë­í•´?", ì¦‰í¥ì , ì‚¬êµì ',
    'ESFP': 'ê¸ì •ì , "ì¬ë°Œê² ë‹¤!", ìˆœê°„ì¦ê¸°ê¸°, ê°ì •í‘œí˜„',
  };

  /// ğŸ¯ í˜ë¥´ì†Œë‚˜ì— ë§ëŠ” ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
  /// ë¶ˆí•„ìš”í•œ ë¶€ë¶„ì€ ì œì™¸í•˜ê³  í•„ìš”í•œ ë¶€ë¶„ë§Œ ì¡°í•©
  static String buildOptimizedPrompt({
    required Persona persona,
    required String relationshipType,
  }) {
    final List<String> promptParts = [];
    
    // 1. í•µì‹¬ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (í•­ìƒ í¬í•¨)
    promptParts.add(_corePrompt);
    
    // 2. ì„±ë³„ë³„ ìŠ¤íƒ€ì¼ (í•´ë‹¹í•˜ëŠ” ê²ƒë§Œ)
    if (persona.gender == 'male') {
      promptParts.add(_maleStyle);
    } else {
      promptParts.add(_femaleStyle);
    }
    
    // 3. MBTI ìŠ¤íƒ€ì¼ (í•´ë‹¹í•˜ëŠ” ê²ƒë§Œ)
    final mbtiStyle = _mbtiStyles[persona.mbti.toUpperCase()];
    if (mbtiStyle != null) {
      promptParts.add('## ğŸ§  MBTI íŠ¹ì„±: $mbtiStyle');
    }
    
    // 4. ì˜ˆì˜ ìˆ˜ì¤€ (í•´ë‹¹í•˜ëŠ” ê²ƒë§Œ)
    if (persona.isCasualSpeech) {
      promptParts.add(_casualMode);
    } else {
      promptParts.add(_formalMode);
    }
    
    // 5. í˜ë¥´ì†Œë‚˜ ì •ë³´
    promptParts.add('''
## ğŸ­ ë‹¹ì‹ ì˜ ìºë¦­í„°
- ì´ë¦„: ${persona.name}
- ë‚˜ì´: ${persona.age}ì„¸  
- ì„±ê²©: ${persona.personality}
${persona.description.isNotEmpty ? '- ì§ì—…/íŠ¹ì§•: ${persona.description}' : ''}
- í˜„ì¬ ê´€ê³„: $relationshipType
- ì¹œë°€ë„: ${persona.relationshipScore}/1000

ìœ„ ëª¨ë“  íŠ¹ì„±ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜í•´ì„œ ${persona.name}ì˜ ê°œì„±ìœ¼ë¡œ ëŒ€í™”í•˜ì„¸ìš”.
''');
    
    return promptParts.join('\n\n');
  }
  
  /// ğŸ“Š í† í° ì ˆì•½ íš¨ê³¼ ê³„ì‚°
  static Map<String, int> calculateTokenSavings({
    required String originalPrompt,
    required String optimizedPrompt,
  }) {
    // ëŒ€ëµì ì¸ í† í° ê³„ì‚° (í•œê¸€ 1ê¸€ì â‰ˆ 1.5í† í°)
    final originalTokens = (originalPrompt.length * 1.5).round();
    final optimizedTokens = (optimizedPrompt.length * 1.5).round();
    final savedTokens = originalTokens - optimizedTokens;
    final savingPercentage = ((savedTokens / originalTokens) * 100).round();
    
    return {
      'original': originalTokens,
      'optimized': optimizedTokens,
      'saved': savedTokens,
      'percentage': savingPercentage,
    };
  }
} 